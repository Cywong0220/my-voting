<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>92781野餐出游｜投票</title>
  <link rel="stylesheet" href="/main.css"/>
  <style>
    .jars { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; height:calc(100% - 8px); }
    .jarWrap { display:flex; flex-direction:column; gap:8px; height:100%; }
    .jarTitle { text-align:center; font-weight:700; opacity:.9; }
    .jarCanvas { width:100%; height:100%; background:#0b1220; border-radius:16px; }
    .nameRow { display:flex; gap:8px; }
    .nameRow input { flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--text); }
    .opt2 { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin-bottom:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="header">
    <div class="title" id="title">投票活動</div>
    <div class="badge">線上同步展示</div>
  </div>

  <div class="layout">
    <!-- 左側：姓名 + 日期複選 -->
    <div class="left">
      <div class="card">
        <label>你的名字（會顯示在掉落的 token 上）</label>
        <div class="nameRow">
          <input id="inpName" type="text" placeholder="請輸入姓名（最多16字）"/>
        </div>

        <label style="margin-top:12px;">請勾選你可以的日期（可複選）</label>
        <div id="opts"></div>

        <button id="btnVote" class="btn">送出投票</button>
        <!-- <div class="small">提示：示範版未做「每人僅投一次」與驗證；可之後加上。</div> -->
      </div>

      <div class="card" style="margin-top:12px;">
        <label>目前統計</label>
        <div id="stat" class="stat small"></div>
      </div>
    </div>

    <!-- 右側：三個玻璃罐 -->
    <div class="right">
      <div class="jars" id="jars"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/jar.js"></script>
  <script>
    const $ = (s)=>document.querySelector(s);
    const titleEl = $("#title"), optsEl = $("#opts"), statEl = $("#stat"), jarsEl = $("#jars");
    const inpName = $("#inpName"); const btn = $("#btnVote");
    const socket = io();
    let CONFIG = { title:"", options:[] }, STATS = {};
    const JAR_MAP = new Map(); // optionId -> jarInstance

    function randomColor(){
      const palette = ["#5eead4","#60a5fa","#a78bfa","#f472b6","#f59e0b","#34d399","#fb7185","#22d3ee","#93c5fd","#fbbf24"];
      return palette[Math.floor(Math.random()*palette.length)];
    }

    // 根據名字產生穩定顏色（同名同色）
    function colorFromName(name){
      const s = (name || "").trim();
      let hash = 0;
      for (let i=0;i<s.length;i++){ hash = ((hash<<5)-hash) + s.charCodeAt(i); hash |= 0; }
      const hue = Math.abs(hash) % 360;        // 0~359
      const sat = 65;                          // 飽和度%
      const light = 55;                        // 亮度%
      return `hsl(${hue} ${sat}% ${light}%)`;
    }

    // 產生縮寫（中文取末兩字，英文取前3-4字母）
    function labelFromName(name){
      const s = (name || "").trim();
      if (!s) return "匿名";
      // 英文或數字
      if (/^[\x00-\x7F]+$/.test(s)) return s.slice(0, 4).toUpperCase();
      // 中文
      if (s.length <= 2) return s;
      return s.slice(-2);
    }

    function renderOptions(){
      optsEl.innerHTML = CONFIG.options.map(o => `
        <label class="opt2">
          <input type="checkbox" name="dateOpt" value="${o.id}"/> ${o.label}
        </label>
      `).join("");
    }

    function renderStats(){
      const arr = CONFIG.options.map(o => ({ label:o.label, id:o.id, c: STATS[o.id]||0 }))
                                .sort((a,b)=> b.c - a.c);
      statEl.innerHTML = arr.map(x => `<span>${x.label}: ${x.c}</span>`).join("");
    }

    function renderJars(){
      jarsEl.innerHTML = CONFIG.options.map(o => `
        <div class="jarWrap" data-id="${o.id}">
          <div class="jarTitle">${o.label}</div>
          <canvas class="jarCanvas" id="cv_${o.id}"></canvas>
        </div>
      `).join("");
      // 為每個日期建立一個 Jar 實例
      // renderJars() 內
      CONFIG.options.forEach(o => {
        const canvas = document.getElementById("cv_"+o.id);
        const jar = Jar.create(canvas, { radius: 34 }); // ← 想更大改這裡，如 40
        JAR_MAP.set(o.id, jar);
      });
    }

    async function vote(){
      const name = inpName.value.trim();
      if (!name) return alert("請先輸入名字");
      const checked = [...document.querySelectorAll('input[name="dateOpt"]:checked')].map(i=>i.value);
      if (checked.length === 0) return alert("請至少勾選一個日期");

      const res = await fetch("/api/vote", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name, optionIds: checked })
      });
      const data = await res.json();
    }

    btn.addEventListener("click", vote);

    socket.on("snapshot", ({ config, stats, history }) => {
      CONFIG = config; STATS = stats || {};
      document.title = CONFIG.title + "｜投票＋玻璃罐";
      titleEl.textContent = CONFIG.title;

      renderOptions(); renderStats(); renderJars();

      // 重播歷史：每個選項，把名字依序丟進該罐
      if (history) {
        CONFIG.options.forEach(o => {
          const jar = JAR_MAP.get(o.id);
          const names = history[o.id] || [];
          names.forEach(n => {
            jar && jar.spawnToken(labelFromName(n), colorFromName(n));
          });
        });
      }
    });

    socket.on("vote", ({ optionId, label, name, count }) => {
      STATS[optionId] = count;
      renderStats();
      const jar = JAR_MAP.get(optionId);
      if (jar) jar.spawnToken(labelFromName(name), colorFromName(name));
    });

    socket.on("reset", () => {
      STATS = {}; renderStats();
      JAR_MAP.forEach(j => j.clearTokens());
    });
  </script>
</body>
</html>
